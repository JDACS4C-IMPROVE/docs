<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; IMPROVE 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            IMPROVE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="QuickStart.html">Quickstart</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="EVALUATION.html">Benchmark Evaluation Schemes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="eval_csa.html">Cross-Study Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="eval_lc.html">Learning Curves</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="USING.html">Using Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using_running.html">Running a Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="using_containers_build.html">Building Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="using_csa.html">CSA</a><ul>
<li class="toctree-l3"><a class="reference internal" href="using_csa_bruteforce.html">Brute-Force CSA</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_csa_parsl.html">Scaling CSA</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="using_hpo.html">HPO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="using_hpo_prerequisites.html">HPO Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_hpo_req.html">HPO Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_hpo_parameters.html">HPO Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_hpo-debug-without-containers-lambda.html">HPO without Containers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">IMPROVE API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api_preprocess.html">Preprocess</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_train.html">Train</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_infer.html">Infer</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_model.html">Creating model params</a></li>
<li class="toctree-l2"><a class="reference internal" href="api_config.html">Configuration Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="release_branch_names.html">Branch Naming</a></li>
<li class="toctree-l2"><a class="reference internal" href="release_v0.1.0.html">v0.1.0</a><ul>
<li class="toctree-l3"><a class="reference internal" href="release_v0.1.0_checklist.html">v0.1.0 Checklist</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="release_v0.0.3.html">v0.0.3</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IMPROVE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/content/curating_tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this heading"></a></h1>
<p>NATASHA: UPDATE THIS</p>
<p>IMPROVE comparison workflows require that prediction models adhere a unitified code interface.</p>
<p>In the realm of supervised learning models, three fundamental components exist: data preparation, model training and hyperparameter optimization (HPO), and performance evaluation [<a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fmed.2023.1086097/full">1</a>].
Recognizing this norm, we propose to establish three distinct scripts, with each script dedicated to one of these essential components.
By establishing this convention and separating the components into separate scripts we aim to enhance code readability, provenance, and maintainability.
The first script handles <strong>preprocessing</strong> of input data, the second manages model <strong>training</strong>, and the third enables the utilization of the model in <strong>inference</strong> mode.
All these scripts should be organized in a modular and flexible manner to enable seamless combination, integration, and workflow generation.
This modular separation of components aims to facilitate an efficient and manageable workflow design and implemenation.</p>
<div class="line-block">
<div class="line">To adhere the unified code interface, model repositories are required to provide a python script for each of the three components and one text file specifying default pamateter values. All three scripts utilize functionality from <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/IMPROVE">IMPROVE library</a>.</div>
</div>
<div class="line-block">
<div class="line">1. <a class="reference internal" href="#preprocessing"><span class="std std-ref">Preprocessing</span></a>. Preprocessing transforms benchmark data (a.k.a <em>raw data</em>) into model specific input data (a.k.a <em>ML data</em>). An example of <em>raw data</em> and <em>ML data</em> in the context of <a class="reference internal" href="app_drp_intro.html#drug-response-prediction"><span class="std std-ref">drug response prediction</span></a> (DRP) are described in <a class="reference internal" href="applications.html#applications"><span class="std std-ref">applications</span></a>.</div>
<div class="line">2. <a class="reference internal" href="old_IGNORE/github-readme-template.html#training"><span class="std std-ref">Training</span></a>. Training and optimization of the model. This often includes <a class="reference internal" href="using_hpo_req.html#hyper-parameter-optimization-hpo"><span class="std std-ref">hyperparameter optimization (HPO)</span></a> and early stopping with validation data to mitigate overfitting.</div>
<div class="line">3. <a class="reference internal" href="old_IGNORE/github-readme-template.html#inference"><span class="std std-ref">Inference</span></a>. Computing predictions and evaluating model prediction performance using the preprocessed data (from step 1) and the trained model (from step 2).</div>
<div class="line">4. <a class="reference internal" href="#parameter-file"><span class="std std-ref">Parameter file</span></a>. A file that contains default parameters for the three scripts.</div>
</div>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="../_images/ML_pipeline_steps.png"><img alt="../_images/ML_pipeline_steps.png" src="../_images/ML_pipeline_steps.png" style="width: 600px;" /></a>
<figcaption>
<p><span class="caption-text">General steps in developing and using prediction model.</span><a class="headerlink" href="#id9" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>In the sections below, we provide an example of the three scripts, showing the use of a <a class="reference external" href="https://lightgbm.readthedocs.io/en/stable/">LightGBM</a> model for drug response prediction.
The <a class="reference internal" href="app_drp_benchmark.html#benchmark-data-for-cross-study-analysis"><span class="std std-ref">cross-study analysis benchmark data</span></a> is used for the analysis.
In these scripts, the interface, the required code components and the utlizization of <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/IMPROVE">IMPROVE library</a> are demonstrated.
The whole code associated with this example can found in <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/tree/develop">this repo</a>.</p>
<p>In the code examples below, required code sections are designated with <em>[Req]</em>. These sections refer to functionality that models must intergrate in their scripts.</p>
<section id="preprocessing">
<h2>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading"></a></h2>
<p>This script preprocesses raw benchmark data (e.g., <a class="reference internal" href="app_drp_benchmark.html#benchmark-data-for-cross-study-analysis"><span class="std std-ref">cross-study analysis</span></a>) and generates data files for a LightGBM prediction model.
The naming convention for the preprocessing script is <cite>MODELNAME_preprocess_improve.py</cite>. For example: <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_preprocess_improve.py">lgbm_preprocess_imporve.py</a>.</p>
<p>All the outputs from the preprocessing script are saved in <code class="docutils literal notranslate"><span class="pre">params[&quot;ml_data_outdir&quot;]</span></code>.</p>
<div class="line-block">
<div class="line"><strong>Outputs from running the preprocessing script</strong>:</div>
</div>
<ol class="arabic">
<li><dl>
<dt><strong>Model input data files.</strong></dt><dd><p>This script creates three data files corresponding to train, validation, and test data.
These data files are used as inputs to the ML/DL prediction model in the <a class="reference internal" href="old_IGNORE/github-readme-template.html#training"><span class="std std-ref">training</span></a> and <a class="reference internal" href="old_IGNORE/github-readme-template.html#inference"><span class="std std-ref">inference</span></a> scripts.
The way that data is structured in these data files is highly depedent on the prediction model. Therefore, the <a class="reference internal" href="old_IGNORE/github-readme-template.html#training"><span class="std std-ref">training</span></a> and <a class="reference internal" href="old_IGNORE/github-readme-template.html#inference"><span class="std std-ref">inference</span></a> scripts should provide and utilize appropriate functionality for data loading and passing it to the model.
The file format is specified by <code class="docutils literal notranslate"><span class="pre">params[&quot;data_format&quot;]</span></code>.
For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">for LightGBM model: <code class="docutils literal notranslate"><span class="pre">train_data.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">val_data.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">test_data.csv</span></code></div>
<div class="line">for GraphDRP model: <code class="docutils literal notranslate"><span class="pre">train_data.pt</span></code>, <code class="docutils literal notranslate"><span class="pre">val_data.pt</span></code>, <code class="docutils literal notranslate"><span class="pre">test_data.pt</span></code></div>
</div>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Y data files.</strong></dt><dd><p>The script also creates dataframes with true Y values and additional metadata.
Regardless of the prediction model, the script generates:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">train_y_data.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">val_y_data.csv</span></code>, and <code class="docutils literal notranslate"><span class="pre">test_y_data.csv</span></code>.</p>
</div></blockquote>
</dd>
</dl>
</li>
</ol>
<p>Note that in addition to the data files mentioned above, the preprocessing script can be used to save additional utility data required by the data loader.</p>
<p>Below is a preprocessing script that takes <a class="reference internal" href="app_drp_benchmark.html#benchmark-data-for-cross-study-analysis"><span class="std std-ref">cross-study analysis benchmark data</span></a> and generates training, validation, and test data files. The script below is available in <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_preprocess_improve.py">this repo</a>. Another example for a preprocessing script can be found in the <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/GraphDRP/blob/develop/graphdrp_preprocess_improve.py">repo</a> for DL model, GraphDRP.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="c1"># [Req] IMPROVE/CANDLE imports</span>
<span class="kn">from</span> <span class="nn">improve</span> <span class="kn">import</span> <span class="n">framework</span> <span class="k">as</span> <span class="n">frm</span>
<span class="kn">from</span> <span class="nn">improve</span> <span class="kn">import</span> <span class="n">drug_resp_pred</span> <span class="k">as</span> <span class="n">drp</span>

<span class="c1"># Model-specifc imports</span>
<span class="kn">from</span> <span class="nn">model_utils.utils</span> <span class="kn">import</span> <span class="n">gene_selection</span><span class="p">,</span> <span class="n">scale_df</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span> <span class="c1"># [Req]</span>

<span class="c1"># ---------------------</span>
<span class="c1"># [Req] Parameter lists</span>
<span class="c1"># ---------------------</span>
<span class="c1"># Two parameter lists are required:</span>
<span class="c1"># 1. app_preproc_params</span>
<span class="c1"># 2. model_preproc_params</span>
<span class="c1">#</span>
<span class="c1"># The values for the parameters in both lists should be specified in a</span>
<span class="c1"># parameter file that is passed as default_model arg in</span>
<span class="c1"># frm.initialize_parameters().</span>

<span class="c1"># 1. App-specific params (App: monotherapy drug response prediction)</span>
<span class="c1"># Note! This list should not be modified (i.e., no params should added or</span>
<span class="c1"># removed from the list.</span>
<span class="c1">#</span>
<span class="c1"># There are two types of params in the list: default and required</span>
<span class="c1"># default:   default values should be used</span>
<span class="c1"># required:  these params must be specified for the model in the param file</span>
<span class="n">app_preproc_params</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;y_data_files&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of files that contain the y (prediction variable) data. </span><span class="se">\</span>
<span class="s2">            Example: [[&#39;response.tsv&#39;]]&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_canc_files&quot;</span><span class="p">,</span> <span class="c1"># required</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of feature files including gene_system_identifer. Examples: </span><span class="se">\n\</span>
<span class="s2">            1) [[&#39;cancer_gene_expression.tsv&#39;, [&#39;Gene_Symbol&#39;]]] </span><span class="se">\n\</span>
<span class="s2">            2) [[&#39;cancer_copy_number.tsv&#39;, [&#39;Ensembl&#39;, &#39;Entrez&#39;]]].&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_drug_files&quot;</span><span class="p">,</span> <span class="c1"># required</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of feature files. Examples: </span><span class="se">\n\</span>
<span class="s2">            1) [[&#39;drug_SMILES.tsv&#39;]] </span><span class="se">\n\</span>
<span class="s2">            2) [[&#39;drug_SMILES.tsv&#39;], [&#39;drug_ecfp4_nbits512.tsv&#39;]]&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;canc_col_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;improve_sample_id&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Column name in the y (response) data file that contains the cancer sample ids.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;drug_col_name&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;improve_chem_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Column name in the y (response) data file that contains the drug ids.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">]</span>

<span class="c1"># 2. Model-specific params (Model: LightGBM)</span>
<span class="c1"># All params in model_preproc_params are optional.</span>
<span class="c1"># If no params are required by the model, then it should be an empty list.</span>
<span class="n">model_preproc_params</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;use_lincs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">frm</span><span class="o">.</span><span class="n">str2bool</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Flag to indicate if landmark genes are used for gene selection.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;scaling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span>
    <span class="s2">&quot;choice&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;minmax&quot;</span><span class="p">,</span> <span class="s2">&quot;miabs&quot;</span><span class="p">,</span> <span class="s2">&quot;robust&quot;</span><span class="p">],</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Scaler for gene expression and Mordred descriptors data.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ge_scaler_fname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_gene_expression_scaler.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;File name to save the gene expression scaler object.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;md_scaler_fname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_mordred_scaler.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;File name to save the Mordred scaler object.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">]</span>

<span class="c1"># [Req] Combine the two lists (the combined parameter list will be passed to</span>
<span class="c1"># frm.initialize_parameters() in the main().</span>
<span class="n">preprocess_params</span> <span class="o">=</span> <span class="n">app_preproc_params</span> <span class="o">+</span> <span class="n">model_preproc_params</span>
<span class="c1"># ---------------------</span>

<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot; Run data preprocessing.</span>

<span class="sd">Args:</span>
<span class="sd">    params (dict): dict of CANDLE/IMPROVE parameters and parsed values.</span>

<span class="sd">Returns:</span>
<span class="sd">    str: directory name that was used to save the preprocessed (generated)</span>
<span class="sd">        ML data files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># [Req] Build paths and create output dir</span>
<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Build paths for raw_data, x_data, y_data, splits</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_paths</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># Create output dir for model input data (to save preprocessed ML data)</span>
<span class="n">frm</span><span class="o">.</span><span class="n">create_outdir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ml_data_outdir&quot;</span><span class="p">])</span>

<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># [Req] Load X data (feature representations)</span>
<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Use the provided data loaders to load data that is required by the model.</span>
<span class="c1">#</span>
<span class="c1"># Benchmark data includes three dirs: x_data, y_data, splits.</span>
<span class="c1"># The x_data contains files that represent feature information such as</span>
<span class="c1"># cancer representation (e.g., omics) and drug representation (e.g., SMILES).</span>
<span class="c1">#</span>
<span class="c1"># Prediction models utilize various types of feature representations.</span>
<span class="c1"># Drug response prediction (DRP) models generally use omics and drug features.</span>
<span class="c1">#</span>
<span class="c1"># If the model uses omics data types that are provided as part of the benchmark</span>
<span class="c1"># data, then the model must use the provided data loaders to load the data files</span>
<span class="c1"># from the x_data dir.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loads omics data.&quot;</span><span class="p">)</span>
<span class="n">omics_obj</span> <span class="o">=</span> <span class="n">drp</span><span class="o">.</span><span class="n">OmicsLoader</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="c1"># print(omics_obj)</span>
<span class="n">ge</span> <span class="o">=</span> <span class="n">omics_obj</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;cancer_gene_expression.tsv&#39;</span><span class="p">]</span> <span class="c1"># return gene expression</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Load drugs data.&quot;</span><span class="p">)</span>
<span class="n">drugs_obj</span> <span class="o">=</span> <span class="n">drp</span><span class="o">.</span><span class="n">DrugsLoader</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="c1"># print(drugs_obj)</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">drugs_obj</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;drug_mordred.tsv&#39;</span><span class="p">]</span> <span class="c1"># return the Mordred descriptors</span>
<span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># TODO. implement reset_index() inside the loader</span>

<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Further preprocess X data</span>
<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Gene selection (based on LINCS landmark genes)</span>
<span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;use_lincs&quot;</span><span class="p">]:</span>
    <span class="n">genes_fpath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">/</span><span class="s2">&quot;landmark_genes&quot;</span>
    <span class="n">ge</span> <span class="o">=</span> <span class="n">gene_selection</span><span class="p">(</span><span class="n">ge</span><span class="p">,</span> <span class="n">genes_fpath</span><span class="p">,</span> <span class="n">canc_col_name</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">])</span>

<span class="c1"># Prefix gene column names with &quot;ge.&quot;</span>
<span class="n">fea_sep</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">fea_prefix</span> <span class="o">=</span> <span class="s2">&quot;ge&quot;</span>
<span class="n">ge</span> <span class="o">=</span> <span class="n">ge</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">fea</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fea_prefix</span><span class="si">}{</span><span class="n">fea_sep</span><span class="si">}{</span><span class="n">fea</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fea</span> <span class="ow">in</span> <span class="n">ge</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>

<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Create feature scaler</span>
<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># Load and combine responses</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Create feature scaler.&quot;</span><span class="p">)</span>
<span class="n">rsp_tr</span> <span class="o">=</span> <span class="n">drp</span><span class="o">.</span><span class="n">DrugResponseLoader</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                                <span class="n">split_file</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;train_split_file&quot;</span><span class="p">],</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="s2">&quot;response.tsv&quot;</span><span class="p">]</span>
<span class="n">rsp_vl</span> <span class="o">=</span> <span class="n">drp</span><span class="o">.</span><span class="n">DrugResponseLoader</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                                <span class="n">split_file</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;val_split_file&quot;</span><span class="p">],</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="s2">&quot;response.tsv&quot;</span><span class="p">]</span>
<span class="n">rsp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rsp_tr</span><span class="p">,</span> <span class="n">rsp_vl</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Retian feature rows that are present in the y data (response dataframe)</span>
<span class="c1"># Intersection of omics features, drug features, and responses</span>
<span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ge</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
<span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
<span class="n">ge_sub</span> <span class="o">=</span> <span class="n">ge</span><span class="p">[</span><span class="n">ge</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">md_sub</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">md</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Scale gene expression</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ge_scaler</span> <span class="o">=</span> <span class="n">scale_df</span><span class="p">(</span><span class="n">ge_sub</span><span class="p">,</span> <span class="n">scaler_name</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">])</span>
<span class="n">ge_scaler_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ml_data_outdir&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ge_scaler_fname&quot;</span><span class="p">]</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ge_scaler</span><span class="p">,</span> <span class="n">ge_scaler_fpath</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scaler object for gene expression: &quot;</span><span class="p">,</span> <span class="n">ge_scaler_fpath</span><span class="p">)</span>

<span class="c1"># Scale Mordred descriptors</span>
<span class="n">_</span><span class="p">,</span> <span class="n">md_scaler</span> <span class="o">=</span> <span class="n">scale_df</span><span class="p">(</span><span class="n">md_sub</span><span class="p">,</span> <span class="n">scaler_name</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">])</span>
<span class="n">md_scaler_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ml_data_outdir&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;md_scaler_fname&quot;</span><span class="p">]</span>
<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">md_scaler</span><span class="p">,</span> <span class="n">md_scaler_fpath</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scaler object for Mordred:         &quot;</span><span class="p">,</span> <span class="n">md_scaler_fpath</span><span class="p">)</span>

<span class="k">del</span> <span class="n">rsp</span><span class="p">,</span> <span class="n">rsp_tr</span><span class="p">,</span> <span class="n">rsp_vl</span><span class="p">,</span> <span class="n">ge_sub</span><span class="p">,</span> <span class="n">md_sub</span>

<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># [Req] Construct ML data for every stage (train, val, test)</span>
<span class="c1"># ------------------------------------------------------</span>
<span class="c1"># All models must load response data (y data) using DrugResponseLoader().</span>
<span class="c1"># Below, we iterate over the 3 split files (train, val, test) and load</span>
<span class="c1"># response data, filtered by the split ids from the split files.</span>

<span class="c1"># Dict with split files corresponding to the three sets (train, val, and test)</span>
<span class="n">stages</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;train_split_file&quot;</span><span class="p">],</span>
            <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;val_split_file&quot;</span><span class="p">],</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_split_file&quot;</span><span class="p">]}</span>

<span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">split_file</span> <span class="ow">in</span> <span class="n">stages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># [Req] Load response data</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">rsp</span> <span class="o">=</span> <span class="n">drp</span><span class="o">.</span><span class="n">DrugResponseLoader</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                                    <span class="n">split_file</span><span class="o">=</span><span class="n">split_file</span><span class="p">,</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">dfs</span><span class="p">[</span><span class="s2">&quot;response.tsv&quot;</span><span class="p">]</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Data prep</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Retain (canc, drug) responses for which both omics and drug features</span>
    <span class="c1"># are available.</span>
    <span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ge</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">rsp</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">ge_sub</span> <span class="o">=</span> <span class="n">ge</span><span class="p">[</span><span class="n">ge</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">]])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">md_sub</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="n">md</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">]])]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Scale features</span>
    <span class="n">ge_sc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scale_df</span><span class="p">(</span><span class="n">ge_sub</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">ge_scaler</span><span class="p">)</span> <span class="c1"># scale gene expression</span>
    <span class="n">md_sc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scale_df</span><span class="p">(</span><span class="n">md_sub</span><span class="p">,</span> <span class="n">scaler</span><span class="o">=</span><span class="n">md_scaler</span><span class="p">)</span> <span class="c1"># scale Mordred descriptors</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># [Req] Save ML data files in params[&quot;ml_data_outdir&quot;]</span>
    <span class="c1"># The implementation of this step, depends on the model.</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># [Req] Build data name</span>
    <span class="n">data_fname</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_ml_data_name</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge data&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ge_sc</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;canc_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">md_sc</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;drug_col_name&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># shuffle</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Save data&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;study&quot;</span><span class="p">])</span> <span class="c1"># to_parquet() throws error since &quot;study&quot; contain mixed values</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ml_data_outdir&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">data_fname</span><span class="p">)</span> <span class="c1"># saves ML data file to parquet</span>

    <span class="c1"># Prepare the y dataframe for the current stage</span>
    <span class="n">fea_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ge&quot;</span><span class="p">,</span> <span class="s2">&quot;mordred&quot;</span><span class="p">]</span>
    <span class="n">fea_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fea_sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">fea_list</span><span class="p">]</span>
    <span class="n">meta_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fea_sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fea_list</span><span class="p">]</span>
    <span class="n">ydf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">meta_cols</span><span class="p">]</span>

    <span class="c1"># [Req] Save y dataframe for the current stage</span>
    <span class="n">frm</span><span class="o">.</span><span class="n">save_stage_ydf</span><span class="p">(</span><span class="n">ydf</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>

<span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ml_data_outdir&quot;</span><span class="p">]</span>

<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># [Req]</span>
    <span class="n">additional_definitions</span> <span class="o">=</span> <span class="n">preprocess_params</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="s2">&quot;lgbm_params.txt&quot;</span><span class="p">,</span>
        <span class="n">additional_definitions</span><span class="o">=</span><span class="n">additional_definitions</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ml_data_outdir</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished data preprocessing.&quot;</span><span class="p">)</span>

<span class="c1"># [Req]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>As mentioned earlier, all the required code sections are designated with <em>[Req]</em>.
One of the requirements is to define two lists of directories: <code class="docutils literal notranslate"><span class="pre">app_preproc_params</span></code> and <code class="docutils literal notranslate"><span class="pre">model_preproc_params</span></code>.
Each dict specifies keyword arguments.</p>
<div class="line-block">
<div class="line">The params in <code class="docutils literal notranslate"><span class="pre">app_preproc_params</span></code> is a collection of application-specific parameters for the preprocessing step. The application in this case is monotherapy drug response prediction. This list should be copied to the script as is. There are two types of params in this list: <em>default</em> and <em>required</em>.</div>
</div>
<ul class="simple">
<li><p><em>default</em>:   default values should be used</p></li>
<li><p><em>required</em>:  the values for params must be specified in the <a class="reference internal" href="#parameter-file"><span class="std std-ref">parameter file</span></a></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app_preproc_params</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;y_data_files&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of files that contain the y (prediction variable) data. </span><span class="se">\</span>
<span class="s2">            Example: [[&#39;response.tsv&#39;]]&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_canc_files&quot;</span><span class="p">,</span> <span class="c1"># required</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of feature files including gene_system_identifer. Examples: </span><span class="se">\n\</span>
<span class="s2">            1) [[&#39;cancer_gene_expression.tsv&#39;, [&#39;Gene_Symbol&#39;]]] </span><span class="se">\n\</span>
<span class="s2">            2) [[&#39;cancer_copy_number.tsv&#39;, [&#39;Ensembl&#39;, &#39;Entrez&#39;]]].&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_drug_files&quot;</span><span class="p">,</span> <span class="c1"># required</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;List of feature files. Examples: </span><span class="se">\n\</span>
<span class="s2">            1) [[&#39;drug_SMILES.tsv&#39;]] </span><span class="se">\n\</span>
<span class="s2">            2) [[&#39;drug_SMILES.tsv&#39;], [&#39;drug_ecfp4_nbits512.tsv&#39;]]&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;canc_col_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;improve_sample_id&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Column name in the y (response) data file that contains the cancer sample ids.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;drug_col_name&quot;</span><span class="p">,</span> <span class="c1"># default</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;improve_chem_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Column name in the y (response) data file that contains the drug ids.&quot;</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The params in <code class="docutils literal notranslate"><span class="pre">model_preproc_params</span></code> is a collection of model-specific parameters for the preprocessing step.
All params in this list are optional. If no params are required by the model, then it should be an empty list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_preproc_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;use_lincs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">frm</span><span class="o">.</span><span class="n">str2bool</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Flag to indicate if landmark genes are used for gene selection.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;scaling&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span>
    <span class="s2">&quot;choice&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;minmax&quot;</span><span class="p">,</span> <span class="s2">&quot;miabs&quot;</span><span class="p">,</span> <span class="s2">&quot;robust&quot;</span><span class="p">],</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Scaler for gene expression and Mordred descriptors data.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ge_scaler_fname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_gene_expression_scaler.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;File name to save the gene expression scaler object.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;md_scaler_fname&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;x_data_mordred_scaler.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;File name to save the Mordred scaler object.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Permalink to this heading"></a></h2>
<p>The training script is used for executing model training as well as conducting <a class="reference internal" href="using_hpo_req.html#hyper-parameter-optimization-hpo"><span class="std std-ref">hyperparameter optimization (HPO)</span></a>. The script generates a trained model, and model predictions and prediction performance scores calculated using the validation data. The naming convention for the training script is <cite>MODELNAME_train_improve.py</cite>. For example: <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_train_improve.py">lgbm_train_imporve.py</a>.</p>
<p>All the outputs from the training script are saved in <code class="docutils literal notranslate"><span class="pre">params[&quot;model_outdir&quot;]</span></code>.</p>
<div class="line-block">
<div class="line"><strong>Outputs from running the training script:</strong></div>
</div>
<ol class="arabic">
<li><dl>
<dt><strong>Trained model.</strong></dt><dd><p>The training script loads the train and validation data that were generated during the <a class="reference internal" href="#preprocessing"><span class="std std-ref">preprocessing</span></a> step.
The train data and validation data are used for, respectively, model training and early stopping.
When the model converges (i.e., prediction performance stops improving on validation data), the model is saved into a file.
The model file name and file format are specified by, respectively, <code class="docutils literal notranslate"><span class="pre">params[&quot;model_file_name&quot;]</span></code> and <code class="docutils literal notranslate"><span class="pre">params[&quot;model_file_format&quot;]</span></code>.
For example:</p>
<blockquote>
<div><div class="line-block">
<div class="line">for LightGBM model: <code class="docutils literal notranslate"><span class="pre">model.txt</span></code></div>
<div class="line">for GraphDRP model: <code class="docutils literal notranslate"><span class="pre">model.pt</span></code></div>
</div>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Predictions on validation data.</strong></dt><dd><p>Model predictions are calcualted using the trained model on validation data.
The predictions are saved as a dataframe in <code class="docutils literal notranslate"><span class="pre">val_y_data_predicted.csv</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Prediction performance scores on validation data.</strong></dt><dd><p>The performance scores are calculated using the model predictions and the true Y values for the performance metrics specified in the <code class="docutils literal notranslate"><span class="pre">metrics_list</span></code>.
The scores are saved as json in <code class="docutils literal notranslate"><span class="pre">val_scores.json</span></code>.</p>
</dd>
</dl>
</li>
</ol>
<p>Below is a training script that takes the generated data from the <a class="reference internal" href="#preprocessing"><span class="std std-ref">preprocessing</span></a> step and trains a LightGBM model. This script is available in <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_train_improve.py">this repo</a>. Another example for a training script can be found in a <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/GraphDRP/blob/develop/graphdrp_train_improve.py">repo</a> for the GraphDRP model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>

<span class="c1"># [Req] IMPROVE/CANDLE imports</span>
<span class="kn">from</span> <span class="nn">improve</span> <span class="kn">import</span> <span class="n">framework</span> <span class="k">as</span> <span class="n">frm</span>

<span class="c1"># Model-specifc imports</span>
<span class="kn">from</span> <span class="nn">model_utils.utils</span> <span class="kn">import</span> <span class="n">extract_subset_fea</span>

<span class="c1"># [Req] Imports from preprocess script</span>
<span class="kn">from</span> <span class="nn">lgbm_preprocess_improve</span> <span class="kn">import</span> <span class="n">preprocess_params</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span> <span class="c1"># [Req]</span>

<span class="c1"># ---------------------</span>
<span class="c1"># [Req] Parameter lists</span>
<span class="c1"># ---------------------</span>
<span class="c1"># Two parameter lists are required:</span>
<span class="c1"># 1. app_train_params</span>
<span class="c1"># 2. model_train_params</span>
<span class="c1">#</span>
<span class="c1"># The values for the parameters in both lists should be specified in a</span>
<span class="c1"># parameter file that is passed as default_model arg in</span>
<span class="c1"># frm.initialize_parameters().</span>

<span class="c1"># 1. App-specific params (App: monotherapy drug response prediction)</span>
<span class="c1"># Currently, there are no app-specific params for this script.</span>
<span class="n">app_train_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 2. Model-specific params (Model: LightGBM)</span>
<span class="c1"># All params in model_train_params are optional.</span>
<span class="c1"># If no params are required by the model, then it should be an empty list.</span>
<span class="n">model_train_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Learning rate for the optimizer.&quot;</span>
    <span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Combine the two lists (the combined parameter list will be passed to</span>
<span class="c1"># frm.initialize_parameters() in the main().</span>
<span class="n">train_params</span> <span class="o">=</span> <span class="n">app_train_params</span> <span class="o">+</span> <span class="n">model_train_params</span>
<span class="c1"># ---------------------</span>

<span class="c1"># [Req] List of metrics names to compute prediction performance scores</span>
<span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="s2">&quot;pcc&quot;</span><span class="p">,</span> <span class="s2">&quot;scc&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">]</span>


<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Run model training.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict): dict of CANDLE/IMPROVE parameters and parsed values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: prediction performance scores computed on validation data</span>
<span class="sd">            according to the metrics_list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Create output dir and build model path</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Create output dir for trained model, val set predictions, val set</span>
    <span class="c1"># performance scores</span>
    <span class="n">frm</span><span class="o">.</span><span class="n">create_outdir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model_outdir&quot;</span><span class="p">])</span>

    <span class="c1"># Build model path</span>
    <span class="n">modelpath</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_model_path</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model_outdir&quot;</span><span class="p">])</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Create data names for train and val sets</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">train_data_fname</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_ml_data_name</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">val_data_fname</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_ml_data_name</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Load model input data (ML data)</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">tr_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;train_ml_data_dir&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">train_data_fname</span><span class="p">)</span>
    <span class="n">vl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;val_ml_data_dir&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">val_data_fname</span><span class="p">)</span>

    <span class="n">fea_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ge&quot;</span><span class="p">,</span> <span class="s2">&quot;mordred&quot;</span><span class="p">]</span>
    <span class="n">fea_sep</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

    <span class="c1"># Train data</span>
    <span class="n">xtr</span> <span class="o">=</span> <span class="n">extract_subset_fea</span><span class="p">(</span><span class="n">tr_data</span><span class="p">,</span> <span class="n">fea_list</span><span class="o">=</span><span class="n">fea_list</span><span class="p">,</span> <span class="n">fea_sep</span><span class="o">=</span><span class="n">fea_sep</span><span class="p">)</span>
    <span class="n">ytr</span> <span class="o">=</span> <span class="n">tr_data</span><span class="p">[[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;y_col_name&quot;</span><span class="p">]]]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xtr:&quot;</span><span class="p">,</span> <span class="n">xtr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ytr:&quot;</span><span class="p">,</span> <span class="n">ytr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Val data</span>
    <span class="n">xvl</span> <span class="o">=</span> <span class="n">extract_subset_fea</span><span class="p">(</span><span class="n">vl_data</span><span class="p">,</span> <span class="n">fea_list</span><span class="o">=</span><span class="n">fea_list</span><span class="p">,</span> <span class="n">fea_sep</span><span class="o">=</span><span class="n">fea_sep</span><span class="p">)</span>
    <span class="n">yvl</span> <span class="o">=</span> <span class="n">vl_data</span><span class="p">[[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;y_col_name&quot;</span><span class="p">]]]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xvl:&quot;</span><span class="p">,</span> <span class="n">xvl</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;yvl:&quot;</span><span class="p">,</span> <span class="n">yvl</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Prepare, train, and save model</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Prepare model and train settings</span>
    <span class="n">ml_init_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span>
                    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMRegressor</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;regression&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">ml_init_args</span><span class="p">)</span>

    <span class="c1"># Train model</span>
    <span class="n">ml_fit_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;early_stopping_rounds&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">}</span>
    <span class="n">ml_fit_args</span><span class="p">[</span><span class="s1">&#39;eval_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">xvl</span><span class="p">,</span> <span class="n">yvl</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">,</span> <span class="o">**</span><span class="n">ml_fit_args</span><span class="p">)</span>

    <span class="c1"># Save model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">booster_</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">modelpath</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">model</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Load best model and compute predictions</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Load the best saved model (as determined based on val data)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Booster</span><span class="p">(</span><span class="n">model_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">modelpath</span><span class="p">))</span>

    <span class="c1"># Compute predictions</span>
    <span class="n">val_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xvl</span><span class="p">)</span>
    <span class="n">val_true</span> <span class="o">=</span> <span class="n">yvl</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Save raw predictions in dataframe</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">frm</span><span class="o">.</span><span class="n">store_predictions_df</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">val_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model_outdir&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Compute performance scores</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">val_scores</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">compute_performace_scores</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">val_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">val_pred</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model_outdir&quot;</span><span class="p">],</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">val_scores</span>

<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># [Req]</span>
    <span class="n">additional_definitions</span> <span class="o">=</span> <span class="n">preprocess_params</span> <span class="o">+</span> <span class="n">train_params</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="s2">&quot;lgbm_params.txt&quot;</span><span class="p">,</span>
        <span class="n">additional_definitions</span><span class="o">=</span><span class="n">additional_definitions</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">val_scores</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished model training.&quot;</span><span class="p">)</span>

<span class="c1"># [Req]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>Similar to the <a class="reference internal" href="#preprocessing"><span class="std std-ref">preprocessing</span></a> script, the training script requires defining two parameter lists: <code class="docutils literal notranslate"><span class="pre">app_train_params</span></code> and <code class="docutils literal notranslate"><span class="pre">model_train_params</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Currently, there are no app-specific params for this script.</span>
<span class="n">app_train_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># All params in model_train_params are optional.</span>
<span class="c1"># If no params are required by the model, then it should be an empty list.</span>
<span class="n">model_train_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Learning rate for the optimizer.&quot;</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="inference">
<h2>Inference<a class="headerlink" href="#inference" title="Permalink to this heading"></a></h2>
<p>The inference script is used to run the trained model in inferecne mode, allowing to compute predictions on an input data. The script generates model predictions and prediction performance scores for the test data. The naming convention for the inference script is <cite>MODELNAME_infer_improve.py</cite>. For example: <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_infer_improve.py">lgbm_infer_imporve.py</a>.</p>
<p>All the outputs from the training script are saved in <code class="docutils literal notranslate"><span class="pre">params[&quot;infer_outdir&quot;]</span></code>.</p>
<div class="line-block">
<div class="line"><strong>Outputs from executing the training script:</strong></div>
</div>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Predictions on test data.</strong></dt><dd><p>Model predictions calcualted using the trained model on test data.
The predictions are saved as a dataframe in <code class="docutils literal notranslate"><span class="pre">test_y_data_predicted.csv</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Prediction performance scores on test data.</strong></dt><dd><p>The performance scores are calculated using the model predictions and the true Y values for the performance metrics specified in the <code class="docutils literal notranslate"><span class="pre">metrics_list</span></code>.
The scores are saved as json in <code class="docutils literal notranslate"><span class="pre">test_scores.json</span></code>.</p>
</dd>
</dl>
</li>
</ol>
<p>Below is an inference script that takes the generated test data from the <a class="reference internal" href="#preprocessing"><span class="std std-ref">preprocessing</span></a> step and trained a LightGBM model from the <a class="reference internal" href="old_IGNORE/github-readme-template.html#training"><span class="std std-ref">training</span></a> step. This script is available in <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/LGBM/blob/master/lgbm_infer_improve.py">this repo</a>. Another example for an inference script can be found in a <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/GraphDRP/blob/develop/graphdrp_infer_improve.py">repo</a> for the GraphDRP model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>

<span class="c1"># [Req] IMPROVE/CANDLE imports</span>
<span class="kn">from</span> <span class="nn">improve</span> <span class="kn">import</span> <span class="n">framework</span> <span class="k">as</span> <span class="n">frm</span>
<span class="kn">from</span> <span class="nn">improve.metrics</span> <span class="kn">import</span> <span class="n">compute_metrics</span>

<span class="c1"># Model-specifc imports</span>
<span class="kn">from</span> <span class="nn">model_utils.utils</span> <span class="kn">import</span> <span class="n">extract_subset_fea</span>

<span class="c1"># [Req] Imports from preprocess and train scripts</span>
<span class="kn">from</span> <span class="nn">lgbm_preprocess_improve</span> <span class="kn">import</span> <span class="n">preprocess_params</span>
<span class="kn">from</span> <span class="nn">lgbm_train_improve</span> <span class="kn">import</span> <span class="n">metrics_list</span><span class="p">,</span> <span class="n">train_params</span>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span> <span class="c1"># [Req]</span>

<span class="c1"># ---------------------</span>
<span class="c1"># [Req] Parameter lists</span>
<span class="c1"># ---------------------</span>
<span class="c1"># Two parameter lists are required:</span>
<span class="c1"># 1. app_infer_params</span>
<span class="c1"># 2. model_infer_params</span>
<span class="c1">#</span>
<span class="c1"># The values for the parameters in both lists should be specified in a</span>
<span class="c1"># parameter file that is passed as default_model arg in</span>
<span class="c1"># frm.initialize_parameters().</span>

<span class="c1"># 1. App-specific params (App: monotherapy drug response prediction)</span>
<span class="c1"># Currently, there are no app-specific params in this script.</span>
<span class="n">app_infer_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 2. Model-specific params (Model: LightGBM)</span>
<span class="c1"># All params in model_infer_params are optional.</span>
<span class="c1"># If no params are required by the model, then it should be an empty list.</span>
<span class="n">model_infer_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># [Req] Combine the two lists (the combined parameter list will be passed to</span>
<span class="c1"># frm.initialize_parameters() in the main().</span>
<span class="n">infer_params</span> <span class="o">=</span> <span class="n">app_infer_params</span> <span class="o">+</span> <span class="n">model_infer_params</span>
<span class="c1"># ---------------------</span>

<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Run model inference.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict): dict of CANDLE/IMPROVE parameters and parsed values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: prediction performance scores computed on test data according</span>
<span class="sd">            to the metrics_list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Create output dir</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">frm</span><span class="o">.</span><span class="n">create_outdir</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;infer_outdir&quot;</span><span class="p">])</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Create data name for test set</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">test_data_fname</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_ml_data_name</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Load model input data (ML data)</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">te_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;test_ml_data_dir&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">test_data_fname</span><span class="p">)</span>

    <span class="n">fea_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ge&quot;</span><span class="p">,</span> <span class="s2">&quot;mordred&quot;</span><span class="p">]</span>
    <span class="n">fea_sep</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

    <span class="c1"># Test data</span>
    <span class="n">xte</span> <span class="o">=</span> <span class="n">extract_subset_fea</span><span class="p">(</span><span class="n">te_data</span><span class="p">,</span> <span class="n">fea_list</span><span class="o">=</span><span class="n">fea_list</span><span class="p">,</span> <span class="n">fea_sep</span><span class="o">=</span><span class="n">fea_sep</span><span class="p">)</span>
    <span class="n">yte</span> <span class="o">=</span> <span class="n">te_data</span><span class="p">[[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;y_col_name&quot;</span><span class="p">]]]</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Load best model and compute predictions</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># Build model path</span>
    <span class="n">modelpath</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">build_model_path</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">])</span> <span class="c1"># [Req]</span>

    <span class="c1"># Load LightGBM</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Booster</span><span class="p">(</span><span class="n">model_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">modelpath</span><span class="p">))</span>

    <span class="c1"># Predict</span>
    <span class="n">test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">xte</span><span class="p">)</span>
    <span class="n">test_true</span> <span class="o">=</span> <span class="n">yte</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Save raw predictions in dataframe</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">frm</span><span class="o">.</span><span class="n">store_predictions_df</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">test_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;infer_outdir&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------</span>
    <span class="c1"># [Req] Compute performance scores</span>
    <span class="c1"># ------------------------------------------------------</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">compute_performace_scores</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">y_true</span><span class="o">=</span><span class="n">test_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;infer_outdir&quot;</span><span class="p">],</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">test_scores</span>

<span class="c1"># [Req]</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># [Req]</span>
    <span class="n">additional_definitions</span> <span class="o">=</span> <span class="n">preprocess_params</span> <span class="o">+</span> <span class="n">train_params</span> <span class="o">+</span> <span class="n">infer_params</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">default_model</span><span class="o">=</span><span class="s2">&quot;lgbm_params.txt&quot;</span><span class="p">,</span>
        <span class="n">additional_definitions</span><span class="o">=</span><span class="n">additional_definitions</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">test_scores</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished model inference.&quot;</span><span class="p">)</span>

<span class="c1"># [Req]</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>
</div>
<p>Similar to the <a class="reference internal" href="old_IGNORE/github-readme-template.html#training"><span class="std std-ref">training</span></a> script, the inference script requires defining two parameter lists: <code class="docutils literal notranslate"><span class="pre">app_infer_params</span></code> and <code class="docutils literal notranslate"><span class="pre">model_infer_params</span></code>. In the case of LightGBM, both lists are empty.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Currently, there are no app-specific params in this script.</span>
<span class="n">app_infer_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># All params in model_infer_params are optional.</span>
<span class="c1"># If no params are required by the model, then it should be an empty list.</span>
<span class="n">model_infer_params</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</section>
<section id="parameter-file">
<h2>Parameter file<a class="headerlink" href="#parameter-file" title="Permalink to this heading"></a></h2>
<p>The parameter file is a <cite>txt</cite> file that contains default parameters for all three scripts.
The path to this file is passed to <code class="docutils literal notranslate"><span class="pre">frm.initialize_parameters()</span></code> as arg <code class="docutils literal notranslate"><span class="pre">default_model</span></code>.
The functionality enablig <code class="docutils literal notranslate"><span class="pre">frm.initialize_parameters()</span></code> is provided by the <a class="reference external" href="https://candle-lib.readthedocs.io/en/latest/index.html#">CANLDE library</a>.</p>
<p>Example of passing the parameter file to the <code class="docutils literal notranslate"><span class="pre">frm.initialize_parameters()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">frm</span><span class="o">.</span><span class="n">initialize_parameters</span><span class="p">(</span>
    <span class="n">filepath</span><span class="p">,</span>
    <span class="n">default_model</span><span class="o">=</span><span class="s2">&quot;lgbm_params.txt&quot;</span><span class="p">,</span>
    <span class="n">additional_definitions</span><span class="o">=</span><span class="n">additional_definitions</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Example showing the content of the parameter file for LightGBM.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Global_Params]
model_name = &quot;LGBM&quot;

[Preprocess]
train_split_file = &quot;CCLE_split_0_train.txt&quot;
val_split_file = &quot;CCLE_split_0_val.txt&quot;
test_split_file = &quot;CCLE_split_0_test.txt&quot;
ml_data_outdir = &quot;./ml_data/CCLE-CCLE/split_0&quot;
data_format = &quot;.parquet&quot;
y_data_files = [[&quot;response.tsv&quot;]]
x_data_canc_files = [[&quot;cancer_gene_expression.tsv&quot;, [&quot;Gene_Symbol&quot;]]]
x_data_drug_files = [[&quot;drug_mordred.tsv&quot;]]
use_lincs = True
scaling = &quot;std&quot;

[Train]
train_ml_data_dir = &quot;./ml_data/CCLE-CCLE/split_0&quot;
val_ml_data_dir = &quot;./ml_data/CCLE-CCLE/split_0&quot;
model_outdir = &quot;./out_models/CCLE/split_0&quot;
model_file_name = &quot;model&quot;
model_file_format = &quot;.txt&quot;

[Infer]
test_ml_data_dir = &quot;./ml_data/CCLE-CCLE/split_0&quot;
model_dir = &quot;./out_models/CCLE/split_0&quot;
infer_outdir = &quot;./out_infer/CCLE-CCLE/split_0&quot;
</pre></div>
</div>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fmed.2023.1086097/full">1.</a> A. Partin et al. “Deep learning methods for drug response prediction in cancer: Predominant and emerging trends”, Frontiers in Medicine, Section Prediction Oncology, 2023</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, IMPROVE Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: 
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <br>
      </dl>
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>