<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to build a container &mdash; IMPROVE 0.1 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to deploy a container" href="deploying-containers.html" />
    <link rel="prev" title="How to run a container" href="running-containers.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            IMPROVE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatis.html">What is the IMPROVE project?</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing IMPROVE</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="curating_introduction.html">Introduction to Curating a Community Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="curating.html">Curating a Community Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="candle_1.html">Creating a CANDLE Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="candle_2.html">Loading Data Using the candle.file_utils Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-branch-tag-names.html">GitHub branch and tag names and definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-candle-data-dir.html">Tutorial CANDLE_DATA_DIR</a></li>
<li class="toctree-l1"><a class="reference internal" href="running-containers.html">How to run a container</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to build a container</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-bootstrap-sh">Using bootstrap.sh</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-from-definition-file">Building from definition file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deploying-containers.html">How to deploy a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="drp_overview.html">Drug Response Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_curation.html">Model Curation</a></li>
<li class="toctree-l1"><a class="reference internal" href="curated_models.html">Curated Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgment.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="chia_touch.html">DEF</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IMPROVE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How to build a container</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/content/building-containers.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="how-to-build-a-container">
<h1>How to build a container<a class="headerlink" href="#how-to-build-a-container" title="Permalink to this headline">¶</a></h1>
<p>Taken from:</p>
<p><a class="reference external" href="https://github.com/JDACS4C-IMPROVE/Singularity/blob/master/README.building_container.md">https://github.com/JDACS4C-IMPROVE/Singularity/blob/master/README.building_container.md</a></p>
<div class="section" id="using-bootstrap-sh">
<h2>Using bootstrap.sh<a class="headerlink" href="#using-bootstrap-sh" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Options</span><span class="p">:</span>
  <span class="o">-</span><span class="n">n</span><span class="p">:</span> <span class="n">Required</span><span class="o">.</span> <span class="n">Name</span> <span class="k">for</span> <span class="n">the</span> <span class="n">image</span>
  <span class="o">-</span><span class="n">d</span><span class="p">:</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">Singularity</span> <span class="n">definition</span> <span class="n">file</span><span class="o">.</span> <span class="n">Builds</span> <span class="n">an</span> <span class="n">image</span> <span class="kn">from</span> <span class="nn">specified</span> <span class="n">definition</span>
  <span class="o">-</span><span class="n">f</span><span class="p">:</span> <span class="n">Build</span> <span class="n">a</span> <span class="n">base</span> <span class="n">image</span> <span class="k">for</span> <span class="n">a</span> <span class="n">framework</span><span class="o">.</span> <span class="n">Acceptable</span> <span class="n">values</span> <span class="n">are</span><span class="p">:</span> <span class="s1">&#39;pytorch&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorflow&#39;</span><span class="o">.</span>
      <span class="n">If</span> <span class="o">-</span><span class="n">d</span> <span class="n">option</span> <span class="ow">is</span> <span class="n">specified</span><span class="p">,</span> <span class="n">then</span> <span class="o">-</span><span class="n">f</span> <span class="ow">is</span> <span class="n">ignored</span><span class="o">.</span>
  <span class="o">-</span><span class="n">t</span><span class="p">:</span> <span class="n">Tag</span> <span class="k">for</span> <span class="n">Singularity</span> <span class="n">definition</span> <span class="n">file</span><span class="o">.</span> <span class="n">Active</span> <span class="n">only</span> <span class="k">for</span> <span class="o">-</span><span class="n">d</span> <span class="n">option</span><span class="o">.</span> <span class="n">Default</span> <span class="n">value</span> <span class="ow">is</span> <span class="mf">0.0</span><span class="o">.</span><span class="mi">1</span>
  <span class="o">-</span><span class="n">h</span><span class="p">:</span> <span class="n">Help</span>
</pre></div>
</div>
<p>Environmental variables are specified in a file ../config/improve.env</p>
<p>Runtime variables are specified in a file ../config/run.config</p>
</div>
<div class="section" id="building-from-definition-file">
<h2>Building from definition file<a class="headerlink" href="#building-from-definition-file" title="Permalink to this headline">¶</a></h2>
<p>In order to build a container from a definition file, you have to write that definintion file. There are definition files in the definitions directory of the Singularity repository. Your definition file can start by using a pre-built improve image that has tensorflow or pytorch already installed along with candle_lib, or your definition file can start by using a deep learning docker image from dockerhub such as tensorflow/tensorflow:latest-gpu.</p>
<p>Definition files for images should be committed to the definitions directory of the Singularity repository.</p>
<p>Custom containers can be built using the bootstrap.sh command, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bootstrap</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">d</span> <span class="o">../</span><span class="n">definitions</span><span class="o">/</span><span class="n">GraphDRP</span><span class="o">.</span><span class="k">def</span> <span class="o">-</span><span class="n">n</span> <span class="n">GraphDRP</span>
</pre></div>
</div>
<p>When bootstrap.sh is done running with no errors, you will be automatically logged into the sandbox. The following is an iterative process that likely requires rebuilding the container several times as the definition file is updated.</p>
<ol class="arabic simple">
<li><p>Install dependencies and update definition file until the model is running.</p></li>
<li><p>From within the container, demonstrate that the train.sh runs the community model. In this case, CANDLE_DATA_DIR can be any path within the container. See: <a class="reference external" href="https://github.com/JDACS4C-IMPROVE/Singularity/blob/master/src/templates/train.sh">https://github.com/JDACS4C-IMPROVE/Singularity/blob/master/src/templates/train.sh</a></p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CUDA_VISIBLE_DEVICES=0
CANDLE_DATA_DIR=/candle_data_dir
CANDLE_CONFIG=/usr/local/GraphDRP/graphdrp_default_model.txt

train.sh $CUDA_VISIBLE_DEVICES $CANDLE_DATA_DIR $CANDLE_CONFIG
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Denonstrate that train.sh can be invoked from outside the container. These variables are set outside the container and passed in. NOTE: the path that is assigned to CANDLE_CONFIG is relative to CANDLE_DATA_DIR.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CUDA_VISIBLE_DEVICES=0
CANDLE_DATA_DIR=/path/to/host/data_dir
CANDLE_CONFIG=uno_default_model.txt

singularity exec --nv --bind $CANDLE_DATA_DIR:/candle_data_dir &lt;image or sandbox path/name&gt; train.sh $CUDA_VISIBLE_DEVICES $CANDLE_DATA_DIR $CANDLE_CONFIG
</pre></div>
</div>
<p>In the above example, the model config file would exist in /path/to/host/data_dir/uno_default_model.txt on the host. Thus, the CANDLE_CONFIG is relative to CANDLE_DATA_DIR. You run train.sh from outside the container by invoking singularity:</p>
<ol class="arabic simple" start="4">
<li><p>Build a non-writable image from the sandbox and run train.sh</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TODO</span><span class="p">:</span> <span class="n">Document</span> <span class="n">this</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="running-containers.html" class="btn btn-neutral float-left" title="How to run a container" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="deploying-containers.html" class="btn btn-neutral float-right" title="How to deploy a container" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, IMPROVE Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>